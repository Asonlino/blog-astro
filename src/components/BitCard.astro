---
import { formatDateTime } from '../utils/format';

const {
  bit,
  Content,
  author = 'Whono'
} = Astro.props;

const tags = bit.data.tags ?? [];
const placeTag = tags.find((t: string) => t.toLowerCase().startsWith('loc:')) ?? '';
const placeText = placeTag ? placeTag.slice(4).trim() : '';
const normalTags = tags.filter((t: string) => !t.toLowerCase().startsWith('loc:'));
const normalTagItems = normalTags.map((t: string) => `#${t}`);
const base = import.meta.env.BASE_URL ?? '/';
const withBase = (path: string) => {
  if (!path) return path;
  if (/^(?:[a-z]+:)?\/\//i.test(path) || path.startsWith('data:')) return path;
  const baseNormalized = base.endsWith('/') ? base : `${base}/`;
  const clean = path.startsWith('/') ? path.slice(1) : path;
  return `${baseNormalized}${clean}`;
};
type BitImage = { src: string; width: number; height: number; alt?: string };
const images = (bit.data.images ?? []) as BitImage[];
const imageItems = images.map((image) => ({
  ...image,
  src: withBase(image.src)
}));
const maxVisible = 4;
const firstImage = imageItems.length === 1 ? imageItems[0] : null;
const totalImages = imageItems.length;
const wideIndex = totalImages > 1 && totalImages <= maxVisible && totalImages % 2 === 1 ? 0 : -1;
---

<article class="bit-card" data-bit data-slug={bit.data.slug ?? bit.id}>
  <div class="bit-author">
    <div class="avatar" aria-hidden="true">{author[0] ?? 'W'}</div>
    <div class="name">{author}</div>
  </div>

  <div class="bit-body">
    <Content />
  </div>

  {firstImage ? (
    <div class="bit-media">
      <img
        src={firstImage.src}
        alt={firstImage.alt ?? ''}
        width={firstImage.width}
        height={firstImage.height}
        loading="lazy"
      />
    </div>
  ) : imageItems.length > 1 ? (
    <div class="bit-media bit-media--grid">
      <div class="bit-media-grid">
        {imageItems.slice(0, maxVisible).map((image, index) => {
          const isMore = index === maxVisible - 1 && imageItems.length > maxVisible;
          return (
            <button
              type="button"
              class={`bit-media-item${index === wideIndex ? ' bit-media-item--wide' : ''}${isMore ? ' bit-media-item--more' : ''}`}
              data-bit-image-button
              data-bit-image-index={index}
              aria-label={isMore ? `Êü•ÁúãÂÖ®ÈÉ®ÂõæÁâáÔºàÂÖ± ${imageItems.length} Âº†Ôºâ` : `ÂõæÁâá ${index + 1}`}
            >
              <img
                src={image.src}
                alt={image.alt ?? ''}
                width={image.width}
                height={image.height}
                loading="lazy"
              />
              {isMore ? (
                <>
                  <span class="bit-media-more" aria-hidden="true" data-bit-image-open-hidden={maxVisible}>
                    <span class="bit-media-more-short">+ {imageItems.length - maxVisible}</span>
                    <span class="bit-media-more-full">Êü•ÁúãÂÖ∂‰Ωô{imageItems.length - maxVisible}Âº†</span>
                  </span>
                </>
              ) : null}
            </button>
          );
        })}
      </div>
      <script
        type="application/json"
        data-bit-images
        is:inline
        set:html={JSON.stringify(imageItems)}
      ></script>
    </div>
  ) : null}

  <div class="bit-meta">
    <div class="bit-tags">
      {placeText ? (
        <span class="bit-tag bit-tag--place">
          <span class="bit-tag-icon" aria-hidden="true">üìç</span>
          <span class="bit-tag-text">{placeText}</span>
        </span>
      ) : null}
      {normalTagItems.length ? (
        <span class="bit-tag bit-tag--normal">
          <span class="bit-tag-icon" aria-hidden="true">‚ù§</span>
          <span class="bit-tag-list">
            {normalTagItems.map((tag) => (
              <span class="bit-tag-token">{tag}</span>
            ))}
          </span>
        </span>
      ) : null}
    </div>
    <div>{formatDateTime(bit.data.date)}</div>
  </div>
</article>
