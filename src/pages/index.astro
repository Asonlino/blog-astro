---
import BaseLayout from '../layouts/BaseLayout.astro';
import EntryListItem from '../components/EntryListItem.astro';
import { getPublished, isReservedSlug } from '../lib/content';
import { getListExcerpt } from '../utils/excerpt';
import { createWithBase } from '../utils/format';

const base = import.meta.env.BASE_URL ?? '/';
const withBase = createWithBase(base);

const essays = await getPublished('essay', {
  orderBy: (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
});

const visibleEssays = essays.filter((entry) => !isReservedSlug(entry.data.slug ?? entry.id));
const latest = visibleEssays.slice(0, 12);
---

<BaseLayout bodyClass="home">
  <h1 class="sr-only">Astro Themes by Whono</h1>

  <div class="intro intro--serif">
    <span class="intro__lead">無限進步</span>
    
    <div class="ip-info-line" style="margin: 8px 0; font-size: 0.9em; color: var(--text-muted, #666);">
      IP地址：<span id="display-ip">正在获取...</span> &nbsp; 地区：<span id="display-region">正在获取...</span>
    </div>

    <span class="intro__more">更多文章请访问 <a href={withBase('/archive/')}>归档</a> 或 <a href={withBase('/essay/')}>随笔</a>。</span>
  </div>

  <h2 class="section-title section-title--index">索引</h2>

  <div class="list">
    {latest.map((entry) => {
      const slug = entry.data.slug ?? entry.id;
      const href = withBase(`/archive/${slug}/`);
      const tag = entry.data.tags?.[0];
      return (
        <EntryListItem
          href={href}
          title={entry.data.title}
          date={entry.data.date}
          tag={tag}
          excerpt={getListExcerpt(entry)}
        />
      );
    })}
  </div>
</BaseLayout>

<script>
  async function fetchIPData() {
    const displayIp = document.getElementById('display-ip');
    const displayRegion = document.getElementById('display-region');

    if (!displayIp || !displayRegion) return;

    function fetchWithTimeout(url, timeoutMs = 5000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        
        return fetch(url, { signal: controller.signal })
            .then(res => {
                clearTimeout(timeoutId);
                return res.ok ? res.json() : null;
            })
            .catch(err => {
                clearTimeout(timeoutId);
                return null;
            });
    }

    try {
        const ipv4Res = await fetchWithTimeout('https://geoip4.icysn.cn/api/json', 5000);

        if (ipv4Res?.code === 0 && ipv4Res.data) {
            const data = ipv4Res.data;
            const ip = data.ip || '未知';
            const regions = data.regions || [];
            const country = data.country?.name || '';
            const prov = regions[0] || '';
            const city = regions[1] || '';
            const district = regions[2] || '';

            const regionStr = [country, prov, city, district].filter(Boolean).join(' ') || '未知地区';

            displayIp.textContent = ip;
            displayRegion.textContent = regionStr;
        } else {
            displayIp.textContent = '获取失败 (接口无响应)';
            displayRegion.textContent = '获取失败';
        }
    } catch (err) {
        displayIp.textContent = '获取失败 (网络异常)';
        displayRegion.textContent = '获取失败';
    }
  }

  fetchIPData();
  document.addEventListener('astro:page-load', fetchIPData);
</script>
