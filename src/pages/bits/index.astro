---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BitCard from '../../components/BitCard.astro';
import BitsDraftDialog from '../../components/BitsDraftDialog.astro';
import { render } from 'astro:content';
import { getPublished } from '../../lib/content';

const bits = await getPublished('bits', {
  orderBy: (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
});

const rendered = await Promise.all(
  bits.map(async (bit) => {
    const { Content } = await render(bit);
    return { bit, Content };
  })
);
---

<BaseLayout title="生活絮语">
  <div class="page-header page-header--bits">
    <h1 class="page-title">生活絮语</h1>
    <span class="page-subtitle">生活不需要长篇，记得就好。</span>
  </div>

  <div class="bits-toolbar">
    <div class="bits-controls">
      <div class="bits-search">
        <label class="sr-only" for="bits-search">搜索絮语</label>
        <input id="bits-search" type="search" placeholder="搜索：关键词 / 标签" autocomplete="off" />
        <button class="bits-search-btn" id="bits-search-btn" type="button">搜索</button>
      </div>
      <button
        class="new"
        id="bits-new-btn"
        type="button"
        data-new-bit
        aria-label="碎碎念"
        aria-haspopup="dialog"
        aria-controls="bits-draft-dialog"
      >
        <span class="new-icon" aria-hidden="true">✍</span>
        <span class="new-label">碎碎念</span>
      </button>
    </div>
    <div class="bits-status" id="bits-search-status" role="status" aria-live="polite"></div>
  </div>

  <div id="bits-list">
    {rendered.map(({ bit, Content }) => (
      <BitCard bit={bit} Content={Content} />
    ))}
  </div>

  <BitsDraftDialog />
  <dialog
    class="bits-lightbox"
    id="bits-lightbox"
    aria-label="图片预览"
    aria-hidden="true"
    data-bits-lightbox
    tabindex="-1"
    hidden
  >
    <button class="bits-lightbox-close" type="button" data-bits-lightbox-close aria-label="关闭">×</button>
    <div class="bits-lightbox-navs" aria-hidden="true">
      <button class="bits-lightbox-nav bits-lightbox-prev" type="button" data-bits-lightbox-prev aria-label="上一张">‹</button>
      <button class="bits-lightbox-nav bits-lightbox-next" type="button" data-bits-lightbox-next aria-label="下一张">›</button>
    </div>
    <figure class="bits-lightbox-figure">
      <img data-bits-lightbox-image alt="" />
      <figcaption class="bits-lightbox-meta">
        <span class="bits-lightbox-count" data-bits-lightbox-count></span>
        <span class="bits-lightbox-dots" data-bits-lightbox-dots aria-hidden="true"></span>
      </figcaption>
    </figure>
  </dialog>

  <script>
    import '../../scripts/bits-search.ts';
    import '../../scripts/bits-draft.ts';
    import '../../scripts/bits-lightbox.ts';
  </script>
</BaseLayout>
